<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LSTV Annotation Tool - Login</title>
    <link rel="stylesheet" href="static/css/style.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
</head>
<body class="login-page">
    <div class="login-container">
        <div class="login-card">
            <div class="login-header">
                <h1>LSTV Annotation Tool</h1>
                <p>Lumbosacral Transitional Vertebrae Classification</p>
            </div>
            <div class="login-body">
                <p class="login-description">
                    Sign in with your Google account to begin annotating DICOM studies.
                </p>
                <button id="googleSignInBtn" class="btn btn-google">
                    <svg width="18" height="18" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48">
                        <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/>
                        <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/>
                        <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/>
                        <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/>
                    </svg>
                    Sign in with Google
                </button>
                <div id="errorMessage" class="error-message" style="display:none;"></div>
                <div id="privateBrowsingWarning" class="error-message" style="display:none; background-color: #fef3c7; border-color: #fcd34d; color: #92400e;">
                    <strong>⚠️ Private Browsing Detected</strong><br>
                    If sign-in hangs, please:<br>
                    1. Close this tab<br>
                    2. Open the site in a regular (non-private) window<br>
                    3. Sign in there instead<br>
                    <br>
                    Firebase authentication may not work reliably in private browsing due to third-party cookie restrictions.
                </div>
            </div>
            <div class="login-footer">
                <p>Authorized personnel only</p>
            </div>
        </div>
    </div>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBrYhf0kOBOouieiKZpjc0Nu5NN0qk8xI8",
            authDomain: "lstv-annotation-tool.firebaseapp.com",
            projectId: "lstv-annotation-tool",
            storageBucket: "lstv-annotation-tool.firebasestorage.app",
            messagingSenderId: "525812647843",
            appId: "1:525812647843:web:dd6fc8e55513fdca1a3c16"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const googleProvider = new firebase.auth.GoogleAuthProvider();
        
        // Force account selection every time
        googleProvider.setCustomParameters({
            prompt: 'select_account'
        });
        
        let isSigningIn = false;
        let authCheckTimeout = null;
        
        // Detect private browsing
        function isPrivateBrowsing() {
            return new Promise((resolve) => {
                if ('storage' in navigator && 'estimate' in navigator.storage) {
                    navigator.storage.estimate().then(estimate => {
                        // In Firefox private mode, quota is very limited
                        resolve(estimate.quota < 120000000);
                    }).catch(() => resolve(false));
                } else {
                    resolve(false);
                }
            });
        }
        
        // Check for private browsing on load
        isPrivateBrowsing().then(isPrivate => {
            if (isPrivate) {
                document.getElementById('privateBrowsingWarning').style.display = 'block';
                console.warn('Private browsing detected - authentication may be unreliable');
            }
        });
        
        // Add timeout for auth check
        function startAuthCheckTimeout() {
            authCheckTimeout = setTimeout(() => {
                console.warn('Sign-in appears to be hanging. This may be due to third-party cookie restrictions.');
                const errorDiv = document.getElementById('errorMessage');
                errorDiv.innerHTML = `
                    <strong>Sign-in appears stuck.</strong><br>
                    Try these solutions:<br>
                    1. Close this popup and try again<br>
                    2. Use a regular (non-private) browser window<br>
                    3. Enable third-party cookies for this site<br>
                    4. Try a different browser
                `;
                errorDiv.style.display = 'block';
                
                isSigningIn = false;
                const btn = document.getElementById('googleSignInBtn');
                btn.disabled = false;
                btn.innerHTML = `<svg width="18" height="18" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48">
                    <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/>
                    <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/>
                    <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/>
                    <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/>
                </svg>Sign in with Google`;
            }, 10000); // 10 second timeout
        }
        
        // Check if already logged in
        auth.onAuthStateChanged((user) => {
            if (authCheckTimeout) {
                clearTimeout(authCheckTimeout);
            }
            
            if (user && !isSigningIn) {
                console.log('User already logged in, redirecting...');
                // Redirect to the appropriate page
                const urlParams = new URLSearchParams(window.location.search);
                const dualView = urlParams.get('dual') === 'true';
                window.location.href = dualView ? 'index_dual.html' : 'index.html';
            }
        });
        
        // Google Sign In
        document.getElementById('googleSignInBtn').addEventListener('click', async () => {
            if (isSigningIn) {
                console.log('Sign-in already in progress...');
                return;
            }
            
            isSigningIn = true;
            const btn = document.getElementById('googleSignInBtn');
            btn.disabled = true;
            btn.textContent = 'Opening sign-in window...';
            
            // Hide previous errors
            document.getElementById('errorMessage').style.display = 'none';
            
            // Start timeout
            startAuthCheckTimeout();
            
            try {
                console.log('Starting sign-in with popup...');
                const result = await auth.signInWithPopup(googleProvider);
                
                // Clear timeout on success
                if (authCheckTimeout) {
                    clearTimeout(authCheckTimeout);
                }
                
                console.log('Sign-in successful!', result.user.email);
                
                // Determine which page to redirect to
                const urlParams = new URLSearchParams(window.location.search);
                const dualView = urlParams.get('dual') === 'true';
                
                // Redirect handled by onAuthStateChanged, but we can do it explicitly too
                window.location.href = dualView ? 'index_dual.html' : 'index.html';
                
            } catch (error) {
                // Clear timeout on error
                if (authCheckTimeout) {
                    clearTimeout(authCheckTimeout);
                }
                
                console.error('Sign-in error:', error);
                
                // Only show error if it's not a user-cancelled action
                if (error.code !== 'auth/cancelled-popup-request' && 
                    error.code !== 'auth/popup-closed-by-user') {
                    
                    let errorMsg = `Error: ${error.message}`;
                    
                    // Provide helpful messages for common errors
                    if (error.code === 'auth/popup-blocked') {
                        errorMsg = 'Pop-up blocked! Please allow pop-ups for this site and try again.';
                    } else if (error.code === 'auth/network-request-failed') {
                        errorMsg = 'Network error. Please check your internet connection and try again.';
                    } else if (error.message.includes('cookie') || error.message.includes('storage')) {
                        errorMsg = 'Authentication failed due to cookie/storage restrictions. Please use a regular (non-private) browser window or enable third-party cookies.';
                    }
                    
                    document.getElementById('errorMessage').textContent = errorMsg;
                    document.getElementById('errorMessage').style.display = 'block';
                }
                
                isSigningIn = false;
                btn.disabled = false;
                btn.innerHTML = `<svg width="18" height="18" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48">
                    <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/>
                    <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/>
                    <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/>
                    <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/>
                </svg>Sign in with Google`;
            }
        });
    </script>
</body>
</html>
